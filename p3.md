# Phase 3: EIP-712 Readable Signatures & Optimized Off-Chain Drafting

## Overview
This phase enhances the security and scalability of MedLedger by implementing **EIP-712 (Typed Structured Data Hashing and Signing)** and optimizing the dual-signature workflow. This ensures patients sign human-readable data and reduces gas costs by moving the drafting phase off-chain.

## Part A: EIP-712 Implementation
We implemented the EIP-712 standard to provide **Readable Signatures**. This protocol separates the data to be signed from the hashing algorithm, allowing wallets to display the data in a structured, readable format.

### Key Changes
1.  **Smart Contract**: Added domain separator and type hashing logic.
2.  **Frontend**: Integrated `wagmi`'s `useSignTypedData` to present clear consent screens ("Meds: Aspirin...") instead of opaque hex strings.

## Part B: Architecture Evolution - Off-Chain Drafting
To address the inefficiency of the initial prototype (which required two transactions per prescription), we analyzed three potential gas-payment models for the settlement transaction.

### The New Workflow
1.  **Doctor (Off-Chain)**: Creates draft -> Pins to IPFS -> **Signs EIP-712** -> Sends to Server. (0 Gas)
2.  **Patient (Off-Chain View)**: Reviews draft -> **Co-Signs EIP-712** (Approval).
3.  **Settlement (On-Chain)**: A single transaction `registerPrescription` is submitted containing both signatures.

### Gas Payment Options (Analysis)

#### Option 1: Patient Pays (Selected for Implementation)
The patient collects the doctor's signature (via the API), adds their own signature, and submits the final transaction to the blockchain.
*   **Pros**: Maintains strict "Patient Sovereignty"â€”the patient has the final "button press" control. Simplest backend architecture (no hot wallet management).
*   **Cons**: Patient needs ETH for gas.
*   **Verdict**: Best for current phase.

#### Option 2: Provider Pays (Gasless for Patient)
The patient signs off-chain and sends the signature back to the server. The server (or Doctor's node) submits the transaction.
*   **Pros**: Best UX (Patient needs no ETH). Fits "Business pays infrastructure" model.
*   **Cons**: Requires a secure "Hot Wallet" on the server to pay gas. Higher security risk for keys.
*   **Verdict**: Viable for production scale-up later.

#### Option 3: "Anyone" Pays (Meta-Transactions)
The smart contract function `registerPrescription` is permissionless. It verifies the signatures inside the payload, so `msg.sender` (the payer) can be anyone (Relayer, Patient, Doctor, etc.).
*   **Pros**: Maximum flexibility. Allows switching between Option 1 and Option 2 without contract changes.
*   **Verdict**: **Implemented in Smart Contract.** (Frontend currently uses Option 1).

## Technical Implementation Details
-   **Contract**: Removed `submitDraft`. Added `registerPrescription(data, sigDoctor, sigPatient)`. Added `nonce` mapping to prevent replay attacks of off-chain signatures.
-   **Server**: Updated to act as a temporary holding area for "Pending Drafts" that are signed but not yet settled on-chain.
